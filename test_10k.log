=== STRESS TESTS WORKFLOW STARTED ===
Stress Tests Configuration:
  SIMULATOR_NUM_MESSAGES: 10000
  MAX_ALLOWED_TIME_MS: 30000
Installing .NET Aspire Workload...

Workload(s) 'aspire' are already installed.
Skipping NuGet package signature verification.
Installing pack Aspire.Hosting.Sdk version 8.2.2...
Pack Aspire.Hosting.Sdk version 8.2.2 is already installed.
Writing workload pack installation record for Aspire.Hosting.Sdk version 8.2.2...
Installing pack Aspire.ProjectTemplates version 8.2.2...
Pack Aspire.ProjectTemplates version 8.2.2 is already installed.
Writing workload pack installation record for Aspire.ProjectTemplates version 8.2.2...
Garbage collecting for SDK feature band(s) 8.0.100...

Successfully installed workload(s) aspire.

Installing workloads: 

Skipping NuGet package signature verification.
Installing pack Aspire.Hosting.Sdk version 8.2.2...
Pack Aspire.Hosting.Sdk version 8.2.2 is already installed.
Writing workload pack installation record for Aspire.Hosting.Sdk version 8.2.2...
Installing pack Aspire.ProjectTemplates version 8.2.2...
Pack Aspire.ProjectTemplates version 8.2.2 is already installed.
Writing workload pack installation record for Aspire.ProjectTemplates version 8.2.2...
Garbage collecting for SDK feature band(s) 8.0.100...

Successfully installed workload(s) aspire.

Installing workloads: 

Skipping NuGet package signature verification.
Skipping NuGet package signature verification.
Skipping NuGet package signature verification.
Installing pack Aspire.Hosting.Sdk version 8.2.2...
Pack Aspire.Hosting.Sdk version 8.2.2 is already installed.
Writing workload pack installation record for Aspire.Hosting.Sdk version 8.2.2...
Installing pack Aspire.ProjectTemplates version 8.2.2...
Pack Aspire.ProjectTemplates version 8.2.2 is already installed.
Writing workload pack installation record for Aspire.ProjectTemplates version 8.2.2...
Garbage collecting for SDK feature band(s) 8.0.100...

Successfully installed workload(s) aspire.

Installing workloads: 

Skipping NuGet package signature verification.
Installing pack Aspire.Hosting.Sdk version 8.2.2...
Pack Aspire.Hosting.Sdk version 8.2.2 is already installed.
Writing workload pack installation record for Aspire.Hosting.Sdk version 8.2.2...
Installing pack Aspire.ProjectTemplates version 8.2.2...
Pack Aspire.ProjectTemplates version 8.2.2 is already installed.
Writing workload pack installation record for Aspire.ProjectTemplates version 8.2.2...
Garbage collecting for SDK feature band(s) 8.0.100...

Successfully installed workload(s) aspire.

Building FlinkDotNet solution...
MSBuild version 17.8.27+3ab07f0cf for .NET
  Determining projects to restore...
  All projects are up-to-date for restore.
  FlinkDotNet.Core.Abstractions -> /home/runner/work/FLINK.NET/FLINK.NET/FlinkDotNet/FlinkDotNet.Core.Abstractions/bin/Release/net8.0/FlinkDotNet.Core.Abstractions.dll
  FlinkDotNet.Connectors.Sources.Kafka -> /home/runner/work/FLINK.NET/FLINK.NET/FlinkDotNet/FlinkDotNet.Connectors.Sources.Kafka/bin/Release/net8.0/FlinkDotNet.Connectors.Sources.Kafka.dll
  FlinkDotNet.Connectors.Sources.File -> /home/runner/work/FLINK.NET/FLINK.NET/FlinkDotNet/FlinkDotNet.Connectors.Sources.File/bin/Release/net8.0/FlinkDotNet.Connectors.Sources.File.dll
  FlinkDotNet.Connectors.Sinks.Console -> /home/runner/work/FLINK.NET/FLINK.NET/FlinkDotNet/FlinkDotNet.Connectors.Sinks.Console/bin/Release/net8.0/FlinkDotNet.Connectors.Sinks.Console.dll
  FlinkDotNet.Common.Constants -> /home/runner/work/FLINK.NET/FLINK.NET/FlinkDotNet/FlinkDotNet.Common.Constants/bin/Release/net8.0/FlinkDotNet.Common.Constants.dll
  FlinkDotNet.Storage.FileSystem -> /home/runner/work/FLINK.NET/FLINK.NET/FlinkDotNet/FlinkDotNet.Storage.FileSystem/bin/Release/net8.0/FlinkDotNet.Storage.FileSystem.dll
  FlinkDotNet.Core -> /home/runner/work/FLINK.NET/FLINK.NET/FlinkDotNet/FlinkDotNet.Core/bin/Release/net8.0/FlinkDotNet.Core.dll
  FlinkDotNet.Connectors.Sources.File.Tests -> /home/runner/work/FLINK.NET/FLINK.NET/FlinkDotNet/FlinkDotNet.Connectors.Sources.File.Tests/bin/Release/net8.0/FlinkDotNet.Connectors.Sources.File.Tests.dll
  FlinkDotNet.Connectors.Sinks.Console.Tests -> /home/runner/work/FLINK.NET/FLINK.NET/FlinkDotNet/FlinkDotNet.Connectors.Sinks.Console.Tests/bin/Release/net8.0/FlinkDotNet.Connectors.Sinks.Console.Tests.dll
  FlinkDotNet.Core.Tests -> /home/runner/work/FLINK.NET/FLINK.NET/FlinkDotNet/FlinkDotNet.Core.Tests/bin/Release/net8.0/FlinkDotNet.Core.Tests.dll
  FlinkDotNet.Storage.RocksDB -> /home/runner/work/FLINK.NET/FLINK.NET/FlinkDotNet/FlinkDotNet.Storage.RocksDB/bin/Debug/net8.0/FlinkDotNet.Storage.RocksDB.dll
  FlinkDotNet.Storage.FileSystem.Tests -> /home/runner/work/FLINK.NET/FLINK.NET/FlinkDotNet/FlinkDotNet.Storage.FileSystem.Tests/bin/Release/net8.0/FlinkDotNet.Storage.FileSystem.Tests.dll
  FlinkDotNet.Common.Constants.Tests -> /home/runner/work/FLINK.NET/FLINK.NET/FlinkDotNet/FlinkDotNet.Common.Constants.Tests/bin/Release/net8.0/FlinkDotNet.Common.Constants.Tests.dll
  FlinkDotNet.JobManager -> /home/runner/work/FLINK.NET/FLINK.NET/FlinkDotNet/FlinkDotNet.JobManager/bin/Release/net8.0/FlinkDotNet.JobManager.dll
  FlinkDotNet.Core.Api -> /home/runner/work/FLINK.NET/FLINK.NET/FlinkDotNet/FlinkDotNet.Core.Api/bin/Release/net8.0/FlinkDotNet.Core.Api.dll
  FlinkDotNet.Table.Api -> /home/runner/work/FLINK.NET/FLINK.NET/FlinkDotNet/FlinkDotNet.Table.Api/bin/Release/net8.0/FlinkDotNet.Table.Api.dll
  FlinkDotNet.JobManager.Tests -> /home/runner/work/FLINK.NET/FLINK.NET/FlinkDotNet/FlinkDotNet.JobManager.Tests/bin/Release/net8.0/FlinkDotNet.JobManager.Tests.dll
  FlinkDotNet.TaskManager -> /home/runner/work/FLINK.NET/FLINK.NET/FlinkDotNet/FlinkDotNet.TaskManager/bin/Release/net8.0/FlinkDotNet.TaskManager.dll
  FlinkDotNet.Architecture.Tests -> /home/runner/work/FLINK.NET/FLINK.NET/FlinkDotNet/FlinkDotNet.Architecture.Tests/bin/Release/net8.0/FlinkDotNet.Architecture.Tests.dll

Build succeeded.
    0 Warning(s)
    0 Error(s)

Time Elapsed 00:00:25.03
Building FlinkDotNetAspire solution...
MSBuild version 17.8.27+3ab07f0cf for .NET
  Determining projects to restore...
  All projects are up-to-date for restore.
  FlinkDotNetAspire.AppHost.ServiceDefaults -> /home/runner/work/FLINK.NET/FLINK.NET/FlinkDotNetAspire/FlinkDotNetAspire.AppHost.ServiceDefaults/bin/Release/net8.0/FlinkDotNetAspire.AppHost.ServiceDefaults.dll
  FlinkDotNet.Common.Constants -> /home/runner/work/FLINK.NET/FLINK.NET/FlinkDotNet/FlinkDotNet.Common.Constants/bin/Debug/net8.0/FlinkDotNet.Common.Constants.dll
  FlinkDotNet.Core.Abstractions -> /home/runner/work/FLINK.NET/FLINK.NET/FlinkDotNet/FlinkDotNet.Core.Abstractions/bin/Debug/net8.0/FlinkDotNet.Core.Abstractions.dll
/home/runner/work/FLINK.NET/FLINK.NET/FlinkDotNetAspire/IntegrationTestVerifier/Program.cs(378,76): warning S1172: Remove this unused method parameter 'keyName'. (https://rules.sonarsource.com/csharp/RSPEC-1172) [/home/runner/work/FLINK.NET/FLINK.NET/FlinkDotNetAspire/IntegrationTestVerifier/IntegrationTestVerifier.csproj]
  IntegrationTestVerifier -> /home/runner/work/FLINK.NET/FLINK.NET/FlinkDotNetAspire/IntegrationTestVerifier/bin/Release/net8.0/FlinkDotNet.IntegrationTestVerifier.dll
  FlinkDotNet.Storage.RocksDB -> /home/runner/work/FLINK.NET/FLINK.NET/FlinkDotNet/FlinkDotNet.Storage.RocksDB/bin/Debug/net8.0/FlinkDotNet.Storage.RocksDB.dll
  FlinkDotNet.JobManager -> /home/runner/work/FLINK.NET/FLINK.NET/FlinkDotNet/FlinkDotNet.JobManager/bin/Release/net8.0/FlinkDotNet.JobManager.dll
  FlinkDotNet.Storage.FileSystem -> /home/runner/work/FLINK.NET/FLINK.NET/FlinkDotNet/FlinkDotNet.Storage.FileSystem/bin/Debug/net8.0/FlinkDotNet.Storage.FileSystem.dll
  FlinkDotNet.Connectors.Sources.File -> /home/runner/work/FLINK.NET/FLINK.NET/FlinkDotNet/FlinkDotNet.Connectors.Sources.File/bin/Debug/net8.0/FlinkDotNet.Connectors.Sources.File.dll
  FlinkDotNet.Connectors.Sinks.Console -> /home/runner/work/FLINK.NET/FLINK.NET/FlinkDotNet/FlinkDotNet.Connectors.Sinks.Console/bin/Debug/net8.0/FlinkDotNet.Connectors.Sinks.Console.dll
  FlinkDotNet.Core.Api -> /home/runner/work/FLINK.NET/FLINK.NET/FlinkDotNet/FlinkDotNet.Core.Api/bin/Debug/net8.0/FlinkDotNet.Core.Api.dll
  FlinkDotNet.Core -> /home/runner/work/FLINK.NET/FLINK.NET/FlinkDotNet/FlinkDotNet.Core/bin/Debug/net8.0/FlinkDotNet.Core.dll
  FlinkDotNet.TaskManager -> /home/runner/work/FLINK.NET/FLINK.NET/FlinkDotNet/FlinkDotNet.TaskManager/bin/Release/net8.0/FlinkDotNet.TaskManager.dll
  FlinkJobSimulator -> /home/runner/work/FLINK.NET/FLINK.NET/FlinkDotNetAspire/FlinkJobSimulator/bin/Release/net8.0/FlinkJobSimulator.dll
  FlinkDotNetAspire.AppHost.AppHost -> /home/runner/work/FLINK.NET/FLINK.NET/FlinkDotNetAspire/FlinkDotNetAspire.AppHost.AppHost/bin/Release/net8.0/FlinkDotNetAspire.AppHost.AppHost.dll
  FlinkDotNetAspire.IntegrationTests -> /home/runner/work/FLINK.NET/FLINK.NET/FlinkDotNetAspire/FlinkDotNetAspire.IntegrationTests/bin/Release/net8.0/FlinkDotNetAspire.IntegrationTests.dll

Build succeeded.

/home/runner/work/FLINK.NET/FLINK.NET/FlinkDotNetAspire/IntegrationTestVerifier/Program.cs(378,76): warning S1172: Remove this unused method parameter 'keyName'. (https://rules.sonarsource.com/csharp/RSPEC-1172) [/home/runner/work/FLINK.NET/FLINK.NET/FlinkDotNetAspire/IntegrationTestVerifier/IntegrationTestVerifier.csproj]
    1 Warning(s)
    0 Error(s)

Time Elapsed 00:00:14.56
Starting Aspire AppHost...
Started AppHost with PID: 12940
Waiting 60 seconds for Redis/Kafka container initialization...
Discovering actual Aspire container ports...
=== Discovering Aspire Container Ports ===
Current Docker containers:
NAMES            IMAGE                                PORTS
kafka-bdkwwvcr   confluentinc/confluent-local:7.9.0   8082/tcp, 127.0.0.1:32769->9092/tcp, 127.0.0.1:32770->9093/tcp
redis-rpfdstrt   redis:7.4                            127.0.0.1:32768->6379/tcp
Using Redis container: f03ab2d8c186
Redis mapped to host port: 32768
Redis password found in container environment
Using Kafka container: dac106f2b586
Kafka mapped to host port: 32769

=== Discovery Results ===
✅ Redis discovered on port: 32768
✅ Redis password discovered
✅ Kafka discovered on port: 32769

Environment variables set:
  DOTNET_REDIS_URL: localhost:32768,password=YqE0FFq8A73tADPuKNYXce
  DOTNET_KAFKA_BOOTSTRAP_SERVERS: localhost:32769
Port discovery completed successfully!
0
Starting health checks...
Health check attempt 1/5
=== FlinkDotNet Integration Test Verifier Started ===
Started at: 2025-06-13 21:00:29 UTC
Arguments: --health-check

=== Environment Variables ===
DOTNET_REDIS_URL: localhost:32768,password=YqE0FFq8A73tADPuKNYXce
DOTNET_KAFKA_BOOTSTRAP_SERVERS: localhost:32769
SIMULATOR_NUM_MESSAGES: 10000
SIMULATOR_REDIS_KEY_GLOBAL_SEQUENCE: <not set>
SIMULATOR_REDIS_KEY_SINK_COUNTER: <not set>
SIMULATOR_KAFKA_TOPIC: <not set>
MAX_ALLOWED_TIME_MS: 30000
DOTNET_ENVIRONMENT: <not set>

=== Running in --health-check mode ===

🏥 === INFRASTRUCTURE HEALTH CHECK ===
📋 Validating Redis and Kafka container accessibility

🔍 DISCOVERY: Resolving service connection strings
   ✅ Redis connection string found: localhost:32768,password=YqE0FFq8A73tADPuKNYXce
   ✅ Kafka bootstrap servers found: localhost:32769
   🔌 Testing Kafka port reachability (localhost:32769)...
      ✅ Port reachable

🔴 HEALTH CHECK 1: Redis Service
   📌 GIVEN: Redis container should be accessible at localhost:32768,password=YqE0FFq8A73tADPuKNYXce
   🎯 WHEN: Attempting connection and basic operations
WaitForRedisAsync: connectionString='localhost:32768,password=YqE0FFq8A73tADPuKNYXce', maxAttempts=2, delaySeconds=5
Redis attempt 1/2: Connecting to localhost:32768,password=YqE0FFq8A73tADPuKNYXce
✅ Redis connection successful in 162ms
✅ Redis ping successful
   ✅ THEN: Redis health check PASSED (took 182ms)

🟡 HEALTH CHECK 2: Kafka Service
   📌 GIVEN: Kafka container should be accessible at localhost:32769
   🎯 WHEN: Attempting connection and metadata retrieval
      🔍 Testing Kafka connectivity: bootstrapServers='localhost:32769', maxAttempts=2, delaySeconds=5
      🔧 Fixed IPv6 issue: Using 127.0.0.1:32769 instead of localhost:32769
      ⏳ Kafka attempt 1/2: Connecting to 127.0.0.1:32769
      ✅ Kafka connection successful in 131ms
      📊 Found 2 topics, 1 brokers
   ✅ THEN: Kafka health check PASSED (took 270ms)

🏁 === HEALTH CHECK SUMMARY ===
🎉 INFRASTRUCTURE: ✅ **HEALTHY** - All services accessible
   ✓ Redis: Operational
   ✓ Kafka: Operational
✅ Health check PASSED on attempt 1
Running verification tests...
=== FlinkDotNet Integration Test Verifier Started ===
Started at: 2025-06-13 21:00:29 UTC
Arguments: 

=== Environment Variables ===
DOTNET_REDIS_URL: localhost:32768,password=YqE0FFq8A73tADPuKNYXce
DOTNET_KAFKA_BOOTSTRAP_SERVERS: localhost:32769
SIMULATOR_NUM_MESSAGES: 10000
SIMULATOR_REDIS_KEY_GLOBAL_SEQUENCE: <not set>
SIMULATOR_REDIS_KEY_SINK_COUNTER: <not set>
SIMULATOR_KAFKA_TOPIC: <not set>
MAX_ALLOWED_TIME_MS: 30000
DOTNET_ENVIRONMENT: <not set>

=== Running full verification ===

=== 🧪 FLINK.NET HIGH-THROUGHPUT STRESS TEST VERIFICATION ===
📋 BDD Test Scenario: Local High Throughput Test with Redis Sequenced Messages to Kafka & Redis Sink

📖 GIVEN: Local Flink.NET Setup with Aspire orchestration
   ├─ Redis provides sequence ID generation (key: 'flinkdotnet:global_sequence_id')
   ├─ HighVolumeSourceFunction generates 10,000 ordered messages
   ├─ RedisIncrementSinkFunction counts messages (key: 'flinkdotnet:sample:processed_message_counter')
   └─ KafkaSinkFunction writes messages to topic ('flinkdotnet.sample.topic')

🎯 WHEN: FlinkJobSimulator executes the dual-sink job
   ├─ Source: Redis INCR generates sequence IDs 1 to N
   ├─ Map: SimpleToUpperMapOperator processes messages (P=1 for FIFO order)
   ├─ Fork: Stream splits to Redis sink AND Kafka sink
   └─ Execution: LocalStreamExecutor runs the job

✅ THEN: Expected behavior according to documentation:
   ├─ Global sequence key should equal 10,000
   ├─ Sink counter key should equal 10,000
   ├─ Kafka topic contains 10,000 ordered messages
   └─ FIFO ordering maintained with Redis-generated sequence IDs

✅ Redis connection discovered: localhost:32768,password=YqE0FFq8A73tADPuKNYXce
✅ Kafka bootstrap servers discovered: localhost:32769

🔍 === VERIFICATION EXECUTION ===

🔴 SCENARIO 1: Redis Sink Verification
   📋 Testing: Source sequence generation and sink message counting
🔗 Connecting to Redis (localhost:32768,password=YqE0FFq8A73tADPuKNYXce)...
   ✅ Successfully connected to Redis.

   📋 Verifying Redis data according to stress test documentation:

   🔍 TEST 1.1: Checking Source Sequence Generation
      📌 GIVEN: Redis key 'flinkdotnet:global_sequence_id' should exist
      🎯 WHEN: FlinkJobSimulator completed execution
         📊 Key exists with value: 1,000,000
      ❌ THEN: Value validation FAILED
         📊 Expected: 10,000 messages
         📊 Actual: 1,000,000 messages
         📊 Difference: 990,000 messages (9900.0% gap)
         💡 This indicates HighVolumeSourceFunction stopped early or encountered errors

      🔍 VALUE MISMATCH DIAGNOSTICS:
         📊 Gap Analysis: -990,000 messages missing (-9900.0% failure rate)
         💡 Source Function Insights:
            - Source stopped at 1,000,000/10,000 messages
            - This suggests LocalStreamExecutor timeout or error in source execution
            - Check AppHost logs for source function error messages

   🔍 TEST 1.2: Checking Redis Sink Processing
      📌 GIVEN: Redis key 'flinkdotnet:sample:processed_message_counter' should exist
      🎯 WHEN: FlinkJobSimulator completed execution
      ❌ THEN: Key validation FAILED - Redis key 'flinkdotnet:sample:processed_message_counter' not found
         💡 This indicates the redis sink processing did not execute or failed to write

      🔍 ENHANCED DIAGNOSTICS for missing Redis Sink Processing:
         📋 Found 1 Redis keys with 'flinkdotnet' prefix:
           - flinkdotnet:global_sequence_id: 1000000

   💥 Redis verification result: ❌ **FAILED**
      ❌ Message count mismatch indicates processing pipeline issues

🟡 SCENARIO 2: Kafka Sink Verification
   📋 Testing: Message ordering and content in Kafka topic

   🔗 Connecting to Kafka (localhost:32769)...
   🔧 Fixed IPv6 issue: Using 127.0.0.1:32769 instead of localhost:32769
   📋 GIVEN: Kafka topic 'flinkdotnet.sample.topic' should contain ordered messages
   🎯 WHEN: FlinkJobSimulator completed execution via KafkaSinkFunction
   ✅ Successfully subscribed to Kafka topic: flinkdotnet.sample.topic
Starting to consume messages (timeout: 30s)...
❌ Kafka consume error: Subscribed topic not available: flinkdotnet.sample.topic: Broker: Unknown topic or partition
  Error code: UnknownTopicOrPart
Kafka consumption completed in 1.0s
Total messages received: 0

      🔍 TEST 2.1: Message Volume Validation
         📌 GIVEN: Expected 10,000 messages in topic
         📊 ACTUAL: Received 0 messages
         ❌ THEN: Volume validation FAILED
            📊 Shortfall: 10,000 messages (100.0% missing)
            💡 This indicates KafkaSinkFunction failed to produce all messages

   💥 Kafka verification result: ❌ **FAILED**
      ❌ Message consumption or ordering validation failed

🚀 SCENARIO 3: Performance Requirements
   📋 Testing: Processing time within acceptable limits
   📊 Actual verification time: 1,324ms for 10,000 messages
   ✅ THEN: Performance requirement PASSED
      📈 Expected: ≤ 30,000ms, Actual: 1,324ms

🏁 === FINAL VERIFICATION RESULT ===
💥 STRESS TEST: ❌ **FAILED** - One or more scenarios failed validation
   ℹ️  Check individual scenario results above for details
📅 Completed at: 2025-06-13 21:00:31 UTC
❌ Stress Tests Workflow Failed: Verification tests failed
=== STRESS TESTS WORKFLOW FAILED after 2.0 minutes ===
Stopping AppHost...
